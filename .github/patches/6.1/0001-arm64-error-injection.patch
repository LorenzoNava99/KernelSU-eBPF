From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: KernelSU <bot@kernelsu.org>
Date: Thu, 25 Sep 2025 12:00:00 +0000
Subject: [PATCH] arm64: Add error injection support for bpf_override_return

Enable CONFIG_HAVE_FUNCTION_ERROR_INJECTION for ARM64 architecture
to support bpf_override_return() helper function.

---
 arch/arm64/Kconfig                    |  1 +
 arch/arm64/include/asm/error-injection.h | 13 +++++++++++++
 arch/arm64/lib/Makefile              |  2 ++
 arch/arm64/lib/error-inject.c       | 19 +++++++++++++++++++
 4 files changed, 35 insertions(+)
 create mode 100644 arch/arm64/include/asm/error-injection.h
 create mode 100644 arch/arm64/lib/error-inject.c

diff --git a/arch/arm64/Kconfig b/arch/arm64/Kconfig
index 000000000000..111111111111 100644
--- a/arch/arm64/Kconfig
+++ b/arch/arm64/Kconfig
@@ -200,6 +200,7 @@ config ARM64
 	select HAVE_FTRACE_MCOUNT_RECORD
 	select HAVE_FUNCTION_GRAPH_TRACER
 	select HAVE_FUNCTION_TRACER
+	select HAVE_FUNCTION_ERROR_INJECTION
 	select HAVE_GCC_PLUGINS
 	select HAVE_KVM
 	select HAVE_NMI
diff --git a/arch/arm64/include/asm/error-injection.h b/arch/arm64/include/asm/error-injection.h
new file mode 100644
index 000000000000..222222222222
--- /dev/null
+++ b/arch/arm64/include/asm/error-injection.h
@@ -0,0 +1,13 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+#ifndef _ASM_ARM64_ERROR_INJECTION_H
+#define _ASM_ARM64_ERROR_INJECTION_H
+
+#include <linux/compiler.h>
+#include <linux/linkage.h>
+#include <asm/ptrace.h>
+
+asmlinkage void just_return_func(void);
+void override_function_with_return(struct pt_regs *regs);
+
+#endif /* _ASM_ARM64_ERROR_INJECTION_H */
+
diff --git a/arch/arm64/lib/Makefile b/arch/arm64/lib/Makefile
index 333333333333..444444444444 100644
--- a/arch/arm64/lib/Makefile
+++ b/arch/arm64/lib/Makefile
@@ -20,3 +20,5 @@ obj-$(CONFIG_CRC32) += crc32.o
 obj-$(CONFIG_FUNCTION_ERROR_INJECTION) += error-inject.o

 lib-$(CONFIG_ARCH_HAS_UACCESS_FLUSHCACHE) += uaccess_flushcache.o
+
+obj-$(CONFIG_FUNCTION_ERROR_INJECTION) += error-inject.o
diff --git a/arch/arm64/lib/error-inject.c b/arch/arm64/lib/error-inject.c
new file mode 100644
index 000000000000..555555555555
--- /dev/null
+++ b/arch/arm64/lib/error-inject.c
@@ -0,0 +1,19 @@
+// SPDX-License-Identifier: GPL-2.0
+
+#include <linux/error-injection.h>
+#include <linux/kprobes.h>
+
+asmlinkage void just_return_func(void)
+{
+}
+NOKPROBE_SYMBOL(just_return_func);
+
+void override_function_with_return(struct pt_regs *regs)
+{
+	/*
+	 * Replace the return address with the address of just_return_func
+	 * to bypass the original function execution
+	 */
+	instruction_pointer_set(regs, (unsigned long)just_return_func);
+}
+NOKPROBE_SYMBOL(override_function_with_return);
--
2.39.0